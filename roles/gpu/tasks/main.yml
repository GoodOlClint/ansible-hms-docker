---
- name: Run RHEL-based install.
  ansible.builtin.import_tasks: redhat.yml
  when: gpu_family_override | lower == "redhat"

- name: Run Debian-based install.
  ansible.builtin.import_tasks: debian.yml
  when: ansible_facts["os_family"] | lower == "debian"

- name: Ensure nvidia-container-toolkit package
  ansible.builtin.package:
    name: nvidia-container-toolkit
    update_cache: true
    state: "{{ gpu_prereq_packages_state }}"

- name: Verify nvidia-container-runtime-hook is in $PATH
  shell: "which nvidia-container-runtime-hook"
  register: nvidia_container_runtime_hook_path
  changed_when: false

- name: Exit if nvidia-container-runtime-hook is not in $PATH
  fail:
    msg: "nvidia-container-runtime-hook not found in $PATH"
  when: nvidia_container_runtime_hook_path.rc != 0

- name: Register nvidia-container-toolkit with docker
  shell:
    cmd: "nvidia-ctk runtime configure --runtime=docker"
  notify:
    - restart docker

- name: Restart docker
  systemd:
    state: restarted
    name: "docker"

- name: Verify CUDA container works
  community.docker.docker_container:
    name: nvidia-gpu-validation
    image: ubuntu
    command: nvidia-smi
    runtime: nvidia
    state: started
    device_requests:
      - driver: nvidia
        count: -1
        capabilities:
          - gpu

- name: Remove CUDA container
  community.docker.docker_container:
    name: nvidia-gpu-validation
    state: absent
